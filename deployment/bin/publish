#!/bin/bash

source bin/lib

set -e

if [[ "${CI}" ]]; then
    set -x
fi

function usage() {
    echo -n \
        "Usage: $(basename "$0") --token ACCESS_TOKEN --acr ACR_NAME --tag IMAGE_TAG
Publishes helm charts. Done in the deploy container as Helm is set up.

--token: The ACR login token
--acr: The name of the ACR (e.g. pccomponentstest)
--tag: The tag to publish
"
}

###################
# Parse arguments #
###################

while [[ "$#" -gt 0 ]]; do case $1 in
    --token)
        ACCESS_TOKEN=${2}
        shift
        shift
        ;;
    --acr)
        ACR_NAME=${2}
        shift
        shift
        ;;
    --tag)
        IMAGE_TAG=${2}
        shift
        shift
        ;;
    --help)
        usage
        exit 0
        shift
        ;;
    *)
        usage "Unknown parameter passed: $1"
        shift
        shift
        ;;
    esac done


if [[ -z ${ACCESS_TOKEN} ]]; then
    echo "Must pass in ACCESS_TOKEN with --token"
    exit 1
fi

if [[ -z ${ACR_NAME} ]]; then
    echo "Must pass in ACR_NAME with --acr"
    exit 1
fi

if [[ -z ${IMAGE_TAG} ]]; then
    echo "Must pass in ACCESS_TOKEN with --tag"
    exit 1
fi

if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    echo $ACCESS_TOKEN | helm registry login ${ACR_NAME}.azurecr.io -u 00000000-0000-0000-0000-000000000000 --password-stdin

    # MQE

    helm chart save \
        helm/pc-metadata-query-engine \
        ${ACR_NAME}.azurecr.io/charts/pc-metadata-query-engine:${IMAGE_TAG}

    helm chart push \
        ${ACR_NAME}.azurecr.io/charts/pc-metadata-query-engine:${IMAGE_TAG}

    # DQE

    helm chart save \
        helm/pc-data-query-engine \
        ${ACR_NAME}.azurecr.io/charts/pc-data-query-engine:${IMAGE_TAG}

    helm chart push \
        ${ACR_NAME}.azurecr.io/charts/pc-data-query-engine:${IMAGE_TAG}

    # SAS

    helm chart save \
        helm/pc-pqe-sasapi \
        ${ACR_NAME}.azurecr.io/charts/pc-pqe-sasapi:${IMAGE_TAG}

    helm chart push \
        ${ACR_NAME}.azurecr.io/charts/pc-pqe-sasapi:${IMAGE_TAG}

    # PQE Ingress

    helm chart save \
        helm/pc-pqe-ingress \
        ${ACR_NAME}.azurecr.io/charts/pc-pqe-ingress:${IMAGE_TAG}

    helm chart push \
        ${ACR_NAME}.azurecr.io/charts/pc-pqe-ingress:${IMAGE_TAG}

fi